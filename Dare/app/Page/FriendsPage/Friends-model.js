"use strict";
var observable_1 = require("data/observable");
var observable_array_1 = require("data/observable-array");
var firebase = require("nativescript-plugin-firebase");
var Page = require("ui/frame");
var Friend_1 = require("../Class/Friend/Friend");
var self;
var MainModel = (function (_super) {
    __extends(MainModel, _super);
    function MainModel() {
        _super.call(this);
        this.Friends = new observable_array_1.ObservableArray();
        this.FriendsAsk = new observable_array_1.ObservableArray();
        this.FriendsSearch = new observable_array_1.ObservableArray();
    }
    MainModel.prototype.SearchUser = function () {
        while (this.FriendsSearch.length > 0) {
            this.FriendsSearch.pop();
        }
        if (this.AddUser != null && this.AddUser != "") {
            var onChildEvent = function (result) {
                if (result.type === "ChildAdded") {
                    if (self.CheckUpUser(result.key) == true) {
                        self.AddSearchUser(result.key);
                    }
                }
            };
            // listen to changes in the /users path
            this.path = "/Users";
            firebase.addChildEventListener(onChildEvent, this.path);
        }
        else {
            alert("No element to search");
        }
    };
    MainModel.prototype.AddSearchUser = function (FriendsName) {
        this.FriendsSearch.push(new Friend_1.default(this.Username, FriendsName, false));
    };
    MainModel.prototype.CheckUpUser = function (FriendsName) {
        var ThisFriend;
        ThisFriend = new Array();
        for (var i = 0; i < this.AddUser.length; i++) {
            if (this.AddUser[i] == FriendsName[i]) {
                ThisFriend.push(true);
            }
            else {
                ThisFriend.push(false);
            }
        }
        for (var l = 0; l < ThisFriend.length; l++) {
            if (ThisFriend[l] == false) {
                return false;
            }
        }
        if (FriendsName == this.Username) {
            return false;
        }
        return true;
    };
    MainModel.prototype.AddThisUser = function () {
        var ThisAddUser = this.AddUser;
        var onUser = true;
        if (this.AddUser == null) {
            alert("Not a valid User");
        }
        else {
            var onChildEvent = function (result) {
                if (result.type === "ChildAdded") {
                    if (self.UserConfirmed(self.AddUser, result.key) == true) {
                        self.SendToUser(result.key);
                        onUser = false;
                        return;
                    }
                }
            };
            // listen to changes in the /users path
            this.path = "/Users";
            firebase.addChildEventListener(onChildEvent, this.path);
        }
    };
    MainModel.prototype.UserConfirmed = function (SearchUser, DatabaseUser) {
        if (SearchUser.toLocaleLowerCase() == DatabaseUser.toLocaleLowerCase() && SearchUser.toLocaleLowerCase() != this.Username.toLowerCase()) {
            return true;
        }
        else {
            return false;
        }
    };
    MainModel.prototype.SendToUser = function (ThisAddUser) {
        firebase.setValue("Users/" + ThisAddUser + "/Friends/Request/" + this.Username, false);
    };
    MainModel.prototype.GetDares = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildRemoved") {
                self.deleteDare(result.key);
            }
            if (result.type === "ChildAdded") {
                self.newDare(result.key, result.value.Dare, result.value.From);
            }
        };
        // listen to changes in the /users path
        this.path = "/Dares/" + this.Username;
        firebase.addChildEventListener(onChildEvent, this.path);
        this.path = "";
    };
    MainModel.prototype.SetApplication = function (Username) {
        self = this;
        this.Username = Username;
        this.set("GUIUser", this.Username);
        this.GetRequest();
        this.GetFriends();
    };
    MainModel.prototype.GetScore = function () {
        var onChildEvent = function (result) {
            self.SetUIScore(result.value);
        };
        var path = "/Users/" + this.Username + "/Score";
        firebase.addValueEventListener(onChildEvent, path);
    };
    MainModel.prototype.SetUIScore = function (AScore) {
        this.set("Score", AScore);
    };
    MainModel.prototype.SetScore = function () {
        var adding = 10;
        var Result = this.Score;
        Result = Result + adding;
        firebase.update('/Users/' + this.Username, { 'Score': Result });
    };
    MainModel.prototype.GetFriends = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildAdded") {
                if (self.SetFriends(result.key) == true) {
                    self.AddFriendsToList(result.key);
                }
            }
            if (result.type === "ChildRemoved") {
                self.DeleteFriend(result.key);
            }
        };
        var path = "/Users/" + this.Username + "/Friends/Accept";
        firebase.addChildEventListener(onChildEvent, path);
    };
    MainModel.prototype.GetRequest = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildAdded") {
                self.SetRequest(result.key);
            }
            if (result.type === "ChildRemoved") {
                self.DeleteRequest(result.key);
            }
        };
        // listen to changes in the /users path
        this.path = "/Users/" + this.Username + "/Friends/Request";
        firebase.addChildEventListener(onChildEvent, this.path);
    };
    MainModel.prototype.SetRequest = function (friend) {
        this.FriendsAsk.push(new Friend_1.default(this.Username, friend, false));
    };
    MainModel.prototype.DeleteRequest = function (friend) {
        for (var i = 0; i < this.FriendsAsk.length; i++) {
            if (this.FriendsAsk.getItem(i).FriendsUsername.toLowerCase() === friend.toLowerCase()) {
                this.FriendsAsk.splice(i, 1);
            }
        }
    };
    MainModel.prototype.DeleteFriend = function (friend) {
        for (var i = 0; i < this.Friends.length; i++) {
            if (this.Friends.getItem(i).FriendsUsername.toLowerCase() === friend.toLowerCase()) {
                this.Friends.splice(i, 1);
            }
        }
    };
    MainModel.prototype.SetFriends = function (AFriend) {
        var AddFriend = true;
        for (var i = 0; i < this.Friends.length; i++) {
            if (this.Friends.getItem(i).FriendsUsername.toLowerCase() === AFriend.toLowerCase()) {
                AddFriend = false;
            }
        }
        return AddFriend;
    };
    MainModel.prototype.AddFriendsToList = function (AFriend) {
        this.Friends.push(new Friend_1.default(this.Username, AFriend, true));
    };
    MainModel.prototype.GoBack = function () {
        while (this.Friends.length > 0) {
            this.Friends.pop();
        }
        while (this.FriendsAsk.length > 0) {
            this.FriendsAsk.pop();
        }
        while (this.FriendsSearch.length > 0) {
            this.FriendsSearch.pop();
        }
        this.AddUser = null;
        this.Username = null;
        this.path = null;
        Page.topmost().goBack();
    };
    return MainModel;
}(observable_1.Observable));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MainModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnJpZW5kcy1tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkZyaWVuZHMtbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDJCQUEwQixpQkFBaUIsQ0FBQyxDQUFBO0FBQzVDLGlDQUFnQyx1QkFBdUIsQ0FBQyxDQUFBO0FBQ3hELElBQU8sUUFBUSxXQUFXLDhCQUE4QixDQUFDLENBQUM7QUFHMUQsSUFBTyxJQUFJLFdBQVcsVUFBVSxDQUFDLENBQUM7QUFDbEMsdUJBQW1CLHdCQUF3QixDQUFDLENBQUE7QUFFM0MsSUFBSSxJQUFJLENBQUM7QUFDVjtJQUF3Qiw2QkFBVTtJQWU5QjtRQUVJLGlCQUFPLENBQUM7UUFFUixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksa0NBQWUsRUFBVSxDQUFDO1FBQzdDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxrQ0FBZSxFQUFVLENBQUM7UUFDaEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGtDQUFlLEVBQVUsQ0FBQztJQUN2RCxDQUFDO0lBRUQsOEJBQVUsR0FBVjtRQUVJLE9BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUNuQyxDQUFDO1lBQ0csSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixDQUFDO1FBRUQsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FDOUMsQ0FBQztZQUNHLElBQUksWUFBWSxHQUFHLFVBQVMsTUFBVTtnQkFFdEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FDakMsQ0FBQztvQkFDTyxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBRSxJQUFJLENBQUMsQ0FDdEMsQ0FBQzt3QkFDRyxJQUFJLENBQUMsYUFBYSxD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cEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTCxnQkFBQztBQUFELENBQUMsQUF2U0QsQ0FBd0IsdUJBQVUsR0F1U2pDO0FBRUQ7a0JBQWUsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0eyBPYnNlcnZhYmxlIH0gZnJvbSBcImRhdGEvb2JzZXJ2YWJsZVwiO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlQXJyYXkgfSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlLWFycmF5XCI7XHJcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpO1xyXG5pbXBvcnQge0V2ZW50RGF0YX0gZnJvbSBcImRhdGEvb2JzZXJ2YWJsZVwiO1xyXG5cclxuaW1wb3J0IFBhZ2UgPSByZXF1aXJlKFwidWkvZnJhbWVcIik7XHJcbmltcG9ydCBGcmllbmQgZnJvbSBcIi4uL0NsYXNzL0ZyaWVuZC9GcmllbmRcIjtcclxuXHJcbiB2YXIgc2VsZjtcclxuY2xhc3MgTWFpbk1vZGVsIGV4dGVuZHMgT2JzZXJ2YWJsZXtcclxuICAgXHJcbiAgIFVzZXJuYW1lOiBzdHJpbmc7XHJcbiAgIFxyXG5cclxuICAgIEZyaWVuZHM6IE9ic2VydmFibGVBcnJheTxGcmllbmQ+O1xyXG4gICAgRnJpZW5kc0FzazogT2JzZXJ2YWJsZUFycmF5PEZyaWVuZD47XHJcbiAgICBGcmllbmRzU2VhcmNoOiBPYnNlcnZhYmxlQXJyYXk8RnJpZW5kPjtcclxuICAgIEFkZFVzZXI6IHN0cmluZztcclxuICAgIElucHV0RGFyZTogc3RyaW5nO1xyXG4gICAgcGF0aDogc3RyaW5nO1xyXG4gICAgU2NvcmU6IG51bWJlcjtcclxuXHJcbiAgICBPYnNVc2VyOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKVxyXG4gICAge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5GcmllbmRzID0gbmV3IE9ic2VydmFibGVBcnJheTxGcmllbmQ+KCk7XHJcbiAgICAgICAgdGhpcy5GcmllbmRzQXNrID0gbmV3IE9ic2VydmFibGVBcnJheTxGcmllbmQ+KCk7XHJcbiAgICAgICAgdGhpcy5GcmllbmRzU2VhcmNoID0gbmV3IE9ic2VydmFibGVBcnJheTxGcmllbmQ+KCk7XHJcbiAgICB9XHJcblxyXG4gICAgU2VhcmNoVXNlcigpXHJcbiAgICB7XHJcbiAgICAgICAgd2hpbGUodGhpcy5GcmllbmRzU2VhcmNoLmxlbmd0aCA+IDApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLkZyaWVuZHNTZWFyY2gucG9wKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih0aGlzLkFkZFVzZXIgIT0gbnVsbCAmJiB0aGlzLkFkZFVzZXIgIT0gXCJcIilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHZhciBvbkNoaWxkRXZlbnQgPSBmdW5jdGlvbihyZXN1bHQ6YW55KSBcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKSBcclxuICAgICAgICAgICAgeyAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoc2VsZi5DaGVja1VwVXNlcihyZXN1bHQua2V5KT09dHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuQWRkU2VhcmNoVXNlcihyZXN1bHQua2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgLy8gbGlzdGVuIHRvIGNoYW5nZXMgaW4gdGhlIC91c2VycyBwYXRoXHJcbiAgICAgICAgICAgIHRoaXMucGF0aCA9IFwiL1VzZXJzXCI7XHJcbiAgICAgICAgICAgIGZpcmViYXNlLmFkZENoaWxkRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQsdGhpcy5wYXRoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgYWxlcnQoXCJObyBlbGVtZW50IHRvIHNlYXJjaFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgQWRkU2VhcmNoVXNlcihGcmllbmRzTmFtZTogc3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuRnJpZW5kc1NlYXJjaC5wdXNoKG5ldyBGcmllbmQodGhpcy5Vc2VybmFtZSxGcmllbmRzTmFtZSxmYWxzZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIENoZWNrVXBVc2VyKEZyaWVuZHNOYW1lOnN0cmluZylcclxuICAgIHtcclxuICAgICAgICBsZXQgVGhpc0ZyaWVuZDpBcnJheTxib29sZWFuPjtcclxuICAgICAgICAgVGhpc0ZyaWVuZCA9IG5ldyBBcnJheTxib29sZWFuPigpO1xyXG5cclxuICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaTx0aGlzLkFkZFVzZXIubGVuZ3RoOyBpKyspXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgaWYodGhpcy5BZGRVc2VyW2ldID09IEZyaWVuZHNOYW1lW2ldKVxyXG4gICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICBUaGlzRnJpZW5kLnB1c2godHJ1ZSk7XHJcbiAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICBUaGlzRnJpZW5kLnB1c2goZmFsc2UpO1xyXG4gICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvcih2YXIgbCA9IDA7IGw8VGhpc0ZyaWVuZC5sZW5ndGg7IGwrKyl7XHJcbiAgICAgICAgICAgICAgICBpZihUaGlzRnJpZW5kW2xdID09IGZhbHNlKXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKEZyaWVuZHNOYW1lID09IHRoaXMuVXNlcm5hbWUpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBBZGRUaGlzVXNlcigpXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIFRoaXNBZGRVc2VyID0gdGhpcy5BZGRVc2VyO1xyXG4gICAgICAgIHZhciBvblVzZXIgPSB0cnVlO1xyXG5cclxuICAgICAgICBpZih0aGlzLkFkZFVzZXIgPT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGFsZXJ0KFwiTm90IGEgdmFsaWQgVXNlclwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKSBcclxuICAgICAgICAgICAgICAgIHsgICBcclxuICAgICAgICAgICAgICAgICAgICBpZihzZWxmLlVzZXJDb25maXJtZWQoc2VsZi5BZGRVc2VyLCByZXN1bHQua2V5KSA9PSB0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5TZW5kVG9Vc2VyKHJlc3VsdC5rZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvblVzZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiB0aGUgL3VzZXJzIHBhdGhcclxuICAgICAgICAgICAgdGhpcy5wYXRoID0gXCIvVXNlcnNcIjtcclxuICAgICAgICAgICAgZmlyZWJhc2UuYWRkQ2hpbGRFdmVudExpc3RlbmVyKG9uQ2hpbGRFdmVudCx0aGlzLnBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBVc2VyQ29uZmlybWVkKFNlYXJjaFVzZXI6c3RyaW5nLCBEYXRhYmFzZVVzZXI6c3RyaW5nKXtcclxuXHJcbiAgICAgICAgaWYoU2VhcmNoVXNlci50b0xvY2FsZUxvd2VyQ2FzZSgpID09IERhdGFiYXNlVXNlci50b0xvY2FsZUxvd2VyQ2FzZSgpJiZTZWFyY2hVc2VyLnRvTG9jYWxlTG93ZXJDYXNlKCkhPSB0aGlzLlVzZXJuYW1lLnRvTG93ZXJDYXNlKCkpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFNlbmRUb1VzZXIoVGhpc0FkZFVzZXI6U3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIGZpcmViYXNlLnNldFZhbHVlKFwiVXNlcnMvXCIrVGhpc0FkZFVzZXIrXCIvRnJpZW5kcy9SZXF1ZXN0L1wiK3RoaXMuVXNlcm5hbWUgLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgICBHZXREYXJlcygpXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgaWYocmVzdWx0LnR5cGU9PT1cIkNoaWxkUmVtb3ZlZFwiKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmRlbGV0ZURhcmUocmVzdWx0LmtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlc3VsdC50eXBlID09PSBcIkNoaWxkQWRkZWRcIikgXHJcbiAgICAgICAgICAgIHsgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5uZXdEYXJlKHJlc3VsdC5rZXksIHJlc3VsdC52YWx1ZS5EYXJlLCByZXN1bHQudmFsdWUuRnJvbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gbGlzdGVuIHRvIGNoYW5nZXMgaW4gdGhlIC91c2VycyBwYXRoXHJcbiAgICAgICAgICAgIHRoaXMucGF0aCA9IFwiL0RhcmVzL1wiK3RoaXMuVXNlcm5hbWU7XHJcbiAgICAgICAgICAgIGZpcmViYXNlLmFkZENoaWxkRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQsdGhpcy5wYXRoKTtcclxuICAgICAgICAgICAgdGhpcy5wYXRoID0gXCJcIjtcclxuICAgIH1cclxuXHJcbiAgICBTZXRBcHBsaWNhdGlvbihVc2VybmFtZTpzdHJpbmcpXHJcbiAgICB7XHJcbiAgICAgICAgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5Vc2VybmFtZSA9IFVzZXJuYW1lO1xyXG4gICAgICAgIHRoaXMuc2V0KFwiR1VJVXNlclwiLHRoaXMuVXNlcm5hbWUpO1xyXG4gICAgICAgIHRoaXMuR2V0UmVxdWVzdCgpO1xyXG4gICAgICAgIHRoaXMuR2V0RnJpZW5kcygpO1xyXG4gICAgfVxyXG4gXHJcbiAgICBHZXRTY29yZSgpXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgc2VsZi5TZXRVSVNjb3JlKHJlc3VsdC52YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwYXRoID0gXCIvVXNlcnMvXCIrdGhpcy5Vc2VybmFtZSArIFwiL1Njb3JlXCI7XHJcbiAgICAgICAgZmlyZWJhc2UuYWRkVmFsdWVFdmVudExpc3RlbmVyKG9uQ2hpbGRFdmVudCxwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBTZXRVSVNjb3JlKEFTY29yZTpudW1iZXIpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5zZXQoXCJTY29yZVwiLCBBU2NvcmUpO1xyXG4gICAgfVxyXG5cclxuICAgIFNldFNjb3JlKClcclxuICAgIHtcclxuICAgICAgICBsZXQgYWRkaW5nID0gMTA7XHJcbiAgICAgICAgdmFyIFJlc3VsdCA9IHRoaXMuU2NvcmU7XHJcbiAgICAgICAgUmVzdWx0ID0gUmVzdWx0ICsgYWRkaW5nO1xyXG4gICAgICAgICAgZmlyZWJhc2UudXBkYXRlKFxyXG4gICAgICAgICAgICAnL1VzZXJzLycgKyB0aGlzLlVzZXJuYW1lLFxyXG4gICAgICAgICAgICB7J1Njb3JlJzogUmVzdWx0fVxyXG4gICAgICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIEdldEZyaWVuZHMoKVxyXG4gICAge1xyXG4gICAgICAgICB2YXIgb25DaGlsZEV2ZW50ID0gZnVuY3Rpb24ocmVzdWx0OmFueSkgXHJcbiAgICAgICAgIHtcclxuICAgICAgICAgICAgaWYocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKVxyXG4gICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgaWYoc2VsZi5TZXRGcmllbmRzKHJlc3VsdC5rZXkpID09IHRydWUpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5BZGRGcmllbmRzVG9MaXN0KHJlc3VsdC5rZXkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZihyZXN1bHQudHlwZSA9PT0gXCJDaGlsZFJlbW92ZWRcIilcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5EZWxldGVGcmllbmQocmVzdWx0LmtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHBhdGggPSBcIi9Vc2Vycy9cIit0aGlzLlVzZXJuYW1lICsgXCIvRnJpZW5kcy9BY2NlcHRcIjtcclxuICAgICAgICBmaXJlYmFzZS5hZGRDaGlsZEV2ZW50TGlzdGVuZXIob25DaGlsZEV2ZW50LHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIEdldFJlcXVlc3QoKVxyXG4gICAge1xyXG4gICAgICAgIHZhciBvbkNoaWxkRXZlbnQgPSBmdW5jdGlvbihyZXN1bHQ6YW55KSBcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGlmKHJlc3VsdC50eXBlID09PSBcIkNoaWxkQWRkZWRcIikgXHJcbiAgICAgICAgICAgIHsgICBcclxuICAgICAgICAgICAgICAgIHNlbGYuU2V0UmVxdWVzdChyZXN1bHQua2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKHJlc3VsdC50eXBlID09PSBcIkNoaWxkUmVtb3ZlZFwiKSBcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5EZWxldGVSZXF1ZXN0KHJlc3VsdC5rZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGxpc3RlbiB0byBjaGFuZ2VzIGluIHRoZSAvdXNlcnMgcGF0aFxyXG4gICAgICAgIHRoaXMucGF0aCA9IFwiL1VzZXJzL1wiK3RoaXMuVXNlcm5hbWUgK1wiL0ZyaWVuZHMvUmVxdWVzdFwiO1xyXG4gICAgICAgIGZpcmViYXNlLmFkZENoaWxkRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQsdGhpcy5wYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBTZXRSZXF1ZXN0KGZyaWVuZDogc3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuRnJpZW5kc0Fzay5wdXNoKG5ldyBGcmllbmQodGhpcy5Vc2VybmFtZSxmcmllbmQsZmFsc2UpKTtcclxuICAgIH1cclxuXHJcbiAgICBEZWxldGVSZXF1ZXN0KGZyaWVuZDogc3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgICBmb3IgKHZhciBpPTA7aTx0aGlzLkZyaWVuZHNBc2subGVuZ3RoO2krKykgXHJcbiAgICAgICAgIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuRnJpZW5kc0Fzay5nZXRJdGVtKGkpLkZyaWVuZHNVc2VybmFtZS50b0xvd2VyQ2FzZSgpID09PSBmcmllbmQudG9Mb3dlckNhc2UoKSkgXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgdGhpcy5GcmllbmRzQXNrLnNwbGljZShpLDEpO1xyXG4gICAgICAgICAgICB9ICAgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIERlbGV0ZUZyaWVuZChmcmllbmQ6IHN0cmluZylcclxuICAgIHtcclxuICAgICAgICAgZm9yICh2YXIgaT0wO2k8dGhpcy5GcmllbmRzLmxlbmd0aDtpKyspIFxyXG4gICAgICAgICB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLkZyaWVuZHMuZ2V0SXRlbShpKS5GcmllbmRzVXNlcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gZnJpZW5kLnRvTG93ZXJDYXNlKCkpIFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgIHRoaXMuRnJpZW5kcy5zcGxpY2UoaSwxKTtcclxuICAgICAgICAgICAgfSAgIFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBTZXRGcmllbmRzKEFGcmllbmQ6IHN0cmluZylcclxuICAgIHtcclxuICAgICAgICB2YXIgQWRkRnJpZW5kID0gdHJ1ZTtcclxuICAgICAgICBmb3IgKHZhciBpPTA7aTx0aGlzLkZyaWVuZHMubGVuZ3RoO2krKykgXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5GcmllbmRzLmdldEl0ZW0oaSkuRnJpZW5kc1VzZXJuYW1lLnRvTG93ZXJDYXNlKCkgPT09IEFGcmllbmQudG9Mb3dlckNhc2UoKSkgXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIEFkZEZyaWVuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9ICAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBBZGRGcmllbmQ7XHJcbiAgICB9XHJcblxyXG4gICAgQWRkRnJpZW5kc1RvTGlzdChBRnJpZW5kOnN0cmluZylcclxuICAgIHtcclxuICAgICAgICB0aGlzLkZyaWVuZHMucHVzaChuZXcgRnJpZW5kKHRoaXMuVXNlcm5hbWUsIEFGcmllbmQsIHRydWUpKTtcclxuICAgIH1cclxuXHJcbiAgICBHb0JhY2soKVxyXG4gICAge1xyXG4gICAgICAgIFxyXG4gICAgICAgIHdoaWxlKHRoaXMuRnJpZW5kcy5sZW5ndGggPiAwKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5GcmllbmRzLnBvcCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgd2hpbGUodGhpcy5GcmllbmRzQXNrLmxlbmd0aCA+IDApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLkZyaWVuZHNBc2sucG9wKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aGlsZSh0aGlzLkZyaWVuZHNTZWFyY2gubGVuZ3RoID4gMClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuRnJpZW5kc1NlYXJjaC5wb3AoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuQWRkVXNlciA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5Vc2VybmFtZSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5wYXRoID0gbnVsbDtcclxuICAgICAgICBQYWdlLnRvcG1vc3QoKS5nb0JhY2soKTtcclxuICAgIH1cclxuICBcclxufSBcclxuXHJcbmV4cG9ydCBkZWZhdWx0IE1haW5Nb2RlbDsiXX0=