"use strict";
var observable_1 = require("data/observable");
var observable_array_1 = require("data/observable-array");
var firebase = require("nativescript-plugin-firebase");
var Page = require("ui/frame");
var Friend_1 = require("../Class/Friend/Friend");
var self;
var MainModel = (function (_super) {
    __extends(MainModel, _super);
    function MainModel() {
        _super.call(this);
        this.Friends = new observable_array_1.ObservableArray();
        this.FriendsAsk = new observable_array_1.ObservableArray();
        this.FriendsSearch = new observable_array_1.ObservableArray();
    }
    MainModel.prototype.SearchUser = function () {
        while (this.FriendsSearch.length > 0) {
            this.FriendsSearch.pop();
        }
        if (this.AddUser != null && this.AddUser != "") {
            var onChildEvent = function (result) {
                if (result.type === "ChildAdded") {
                    if (self.CheckUpUser(result.key) == true) {
                        self.AddSearchUser(result.key);
                    }
                }
            };
            // listen to changes in the /users path
            this.path = "/Users";
            firebase.addChildEventListener(onChildEvent, this.path);
        }
        else {
            alert("No element to search");
        }
    };
    MainModel.prototype.AddSearchUser = function (FriendsName) {
        this.FriendsSearch.push(new Friend_1.default(this.Username, FriendsName, false));
    };
    MainModel.prototype.CheckUpUser = function (FriendsName) {
        var ThisFriend;
        ThisFriend = new Array();
        for (var i = 0; i < this.AddUser.length; i++) {
            if (this.AddUser[i] == FriendsName[i]) {
                ThisFriend.push(true);
            }
            else {
                ThisFriend.push(false);
            }
        }
        for (var l = 0; l < ThisFriend.length; l++) {
            if (ThisFriend[l] == false) {
                return false;
            }
        }
        if (FriendsName == this.Username) {
            return false;
        }
        return true;
    };
    MainModel.prototype.AddThisUser = function () {
        var ThisAddUser = this.AddUser;
        var onUser = true;
        if (this.AddUser == null) {
            alert("Not a valid User");
        }
        else {
            var onChildEvent = function (result) {
                if (result.type === "ChildAdded") {
                    if (self.UserConfirmed(self.AddUser, result.key) == true) {
                        self.SendToUser(result.key);
                        onUser = false;
                        return;
                    }
                }
            };
            // listen to changes in the /users path
            this.path = "/Users";
            firebase.addChildEventListener(onChildEvent, this.path);
        }
    };
    MainModel.prototype.UserConfirmed = function (SearchUser, DatabaseUser) {
        if (SearchUser.toLocaleLowerCase() == DatabaseUser.toLocaleLowerCase() && SearchUser.toLocaleLowerCase() != this.Username.toLowerCase()) {
            return true;
        }
        else {
            return false;
        }
    };
    MainModel.prototype.SendToUser = function (ThisAddUser) {
        firebase.setValue("Users/" + ThisAddUser + "/Friends/Request/" + this.Username, false);
    };
    MainModel.prototype.GetDares = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildRemoved") {
                self.deleteDare(result.key);
            }
            if (result.type === "ChildAdded") {
                self.newDare(result.key, result.value.Dare, result.value.From);
            }
        };
        // listen to changes in the /users path
        this.path = "/Dares/" + this.Username;
        firebase.addChildEventListener(onChildEvent, this.path);
        this.path = "";
    };
    MainModel.prototype.Send = function () {
        firebase.push("Dares/" + this.Username, { 'From': this.Username, 'Dare': this.InputDare });
        this.set("Username", "");
        this.set("InputDare", "");
    };
    MainModel.prototype.SetApplication = function (Username) {
        self = this;
        this.Username = Username;
        this.set("GUIUser", this.Username);
        this.GetRequest();
        this.GetFriends();
    };
    MainModel.prototype.GetScore = function () {
        var onChildEvent = function (result) {
            self.SetUIScore(result.value);
        };
        var path = "/Users/" + this.Username + "/Score";
        firebase.addValueEventListener(onChildEvent, path);
    };
    MainModel.prototype.SetUIScore = function (AScore) {
        this.set("Score", AScore);
    };
    MainModel.prototype.SetScore = function () {
        var adding = 10;
        var Result = this.Score;
        Result = Result + adding;
        firebase.update('/Users/' + this.Username, { 'Score': Result });
    };
    MainModel.prototype.GetFriends = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildAdded") {
                if (self.SetFriends(result.key) == true) {
                    self.AddFriendsToList(result.key);
                }
            }
            if (result.type === "ChildRemoved") {
                self.DeleteFriend(result.key);
            }
        };
        var path = "/Users/" + this.Username + "/Friends/Accept";
        firebase.addChildEventListener(onChildEvent, path);
    };
    MainModel.prototype.GetRequest = function () {
        var onChildEvent = function (result) {
            if (result.type === "ChildAdded") {
                self.SetRequest(result.key);
            }
            if (result.type === "ChildRemoved") {
                self.DeleteRequest(result.key);
            }
        };
        // listen to changes in the /users path
        this.path = "/Users/" + this.Username + "/Friends/Request";
        firebase.addChildEventListener(onChildEvent, this.path);
    };
    MainModel.prototype.SetRequest = function (friend) {
        this.FriendsAsk.push(new Friend_1.default(this.Username, friend, false));
    };
    MainModel.prototype.DeleteRequest = function (friend) {
        for (var i = 0; i < this.FriendsAsk.length; i++) {
            if (this.FriendsAsk.getItem(i).FriendsUsername.toLowerCase() === friend.toLowerCase()) {
                this.FriendsAsk.splice(i, 1);
            }
        }
    };
    MainModel.prototype.DeleteFriend = function (friend) {
        for (var i = 0; i < this.Friends.length; i++) {
            if (this.Friends.getItem(i).FriendsUsername.toLowerCase() === friend.toLowerCase()) {
                this.Friends.splice(i, 1);
            }
        }
    };
    MainModel.prototype.SetFriends = function (AFriend) {
        var AddFriend = true;
        for (var i = 0; i < this.Friends.length; i++) {
            if (this.Friends.getItem(i).FriendsUsername.toLowerCase() === AFriend.toLowerCase()) {
                AddFriend = false;
            }
        }
        return AddFriend;
    };
    MainModel.prototype.AddFriendsToList = function (AFriend) {
        this.Friends.push(new Friend_1.default(this.Username, AFriend, true));
    };
    MainModel.prototype.GoBack = function () {
        while (this.Friends.length > 0) {
            this.Friends.pop();
        }
        while (this.FriendsAsk.length > 0) {
            this.FriendsAsk.pop();
        }
        while (this.FriendsSearch.length > 0) {
            this.FriendsSearch.pop();
        }
        this.AddUser = null;
        this.Username = null;
        this.path = null;
        Page.topmost().goBack();
    };
    return MainModel;
}(observable_1.Observable));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MainModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnJpZW5kcy1tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkZyaWVuZHMtbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDJCQUEwQixpQkFBaUIsQ0FBQyxDQUFBO0FBQzVDLGlDQUFnQyx1QkFBdUIsQ0FBQyxDQUFBO0FBQ3hELElBQU8sUUFBUSxXQUFXLDhCQUE4QixDQUFDLENBQUM7QUFHMUQsSUFBTyxJQUFJLFdBQVcsVUFBVSxDQUFDLENBQUM7QUFDbEMsdUJBQW1CLHdCQUF3QixDQUFDLENBQUE7QUFFM0MsSUFBSSxJQUFJLENBQUM7QUFDVjtJQUF3Qiw2QkFBVTtJQWU5QjtRQUVJLGlCQUFPLENBQUM7UUFFUixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksa0NBQWUsRUFBVSxDQUFDO1FBQzdDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxrQ0FBZSxFQUFVLENBQUM7UUFDaEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGtDQUFlLEVBQVUsQ0FBQztJQUN2RCxDQUFDO0lBRUQsOEJBQVUsR0FBVjtRQUVJLE9BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUNuQyxDQUFDO1lBQ0csSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixDQUFDO1FBRUQsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FDOUMsQ0FBQztZQUNHLElBQUksWUFBWSxHQUFHLFVBQVMsTUFBVTtnQkFFdEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FDakMsQ0FBQztvQkFDTyxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBRSxJQUFJLENBQUMsQ0FDdEMsQ0FBQzt3QkFDRyxJQUFJLENBQUMsYUFBYSxD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QixDQUFDO1FBRUQsT0FBTSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQ2hDLENBQUM7WUFDRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzFCLENBQUM7UUFFRCxPQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDbkMsQ0FBQztZQUNHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDN0IsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUwsZ0JBQUM7QUFBRCxDQUFDLEFBOVNELENBQXdCLHVCQUFVLEdBOFNqQztBQUVEO2tCQUFlLFNBQVMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcbmltcG9ydCB7IE9ic2VydmFibGVBcnJheSB9IGZyb20gXCJkYXRhL29ic2VydmFibGUtYXJyYXlcIjtcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpO1xuaW1wb3J0IHtFdmVudERhdGF9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcblxuaW1wb3J0IFBhZ2UgPSByZXF1aXJlKFwidWkvZnJhbWVcIik7XG5pbXBvcnQgRnJpZW5kIGZyb20gXCIuLi9DbGFzcy9GcmllbmQvRnJpZW5kXCI7XG5cbiB2YXIgc2VsZjtcbmNsYXNzIE1haW5Nb2RlbCBleHRlbmRzIE9ic2VydmFibGV7XG4gICBcbiAgIFVzZXJuYW1lOiBzdHJpbmc7XG4gICBcblxuICAgIEZyaWVuZHM6IE9ic2VydmFibGVBcnJheTxGcmllbmQ+O1xuICAgIEZyaWVuZHNBc2s6IE9ic2VydmFibGVBcnJheTxGcmllbmQ+O1xuICAgIEZyaWVuZHNTZWFyY2g6IE9ic2VydmFibGVBcnJheTxGcmllbmQ+O1xuICAgIEFkZFVzZXI6IHN0cmluZztcbiAgICBJbnB1dERhcmU6IHN0cmluZztcbiAgICBwYXRoOiBzdHJpbmc7XG4gICAgU2NvcmU6IG51bWJlcjtcblxuICAgIE9ic1VzZXI6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKClcbiAgICB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLkZyaWVuZHMgPSBuZXcgT2JzZXJ2YWJsZUFycmF5PEZyaWVuZD4oKTtcbiAgICAgICAgdGhpcy5GcmllbmRzQXNrID0gbmV3IE9ic2VydmFibGVBcnJheTxGcmllbmQ+KCk7XG4gICAgICAgIHRoaXMuRnJpZW5kc1NlYXJjaCA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8RnJpZW5kPigpO1xuICAgIH1cblxuICAgIFNlYXJjaFVzZXIoKVxuICAgIHtcbiAgICAgICAgd2hpbGUodGhpcy5GcmllbmRzU2VhcmNoLmxlbmd0aCA+IDApXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuRnJpZW5kc1NlYXJjaC5wb3AoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmKHRoaXMuQWRkVXNlciAhPSBudWxsICYmIHRoaXMuQWRkVXNlciAhPSBcIlwiKVxuICAgICAgICB7XG4gICAgICAgICAgICB2YXIgb25DaGlsZEV2ZW50ID0gZnVuY3Rpb24ocmVzdWx0OmFueSkgXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKSBcbiAgICAgICAgICAgIHsgIFxuICAgICAgICAgICAgICAgICAgICBpZihzZWxmLkNoZWNrVXBVc2VyKHJlc3VsdC5rZXkpPT10cnVlKVxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLkFkZFNlYXJjaFVzZXIocmVzdWx0LmtleSk7XG4gICAgICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiB0aGUgL3VzZXJzIHBhdGhcbiAgICAgICAgICAgIHRoaXMucGF0aCA9IFwiL1VzZXJzXCI7XG4gICAgICAgICAgICBmaXJlYmFzZS5hZGRDaGlsZEV2ZW50TGlzdGVuZXIob25DaGlsZEV2ZW50LHRoaXMucGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZVxuICAgICAgICB7XG4gICAgICAgICAgICBhbGVydChcIk5vIGVsZW1lbnQgdG8gc2VhcmNoXCIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQWRkU2VhcmNoVXNlcihGcmllbmRzTmFtZTogc3RyaW5nKVxuICAgIHtcbiAgICAgICAgdGhpcy5GcmllbmRzU2VhcmNoLnB1c2gobmV3IEZyaWVuZCh0aGlzLlVzZXJuYW1lLEZyaWVuZHNOYW1lLGZhbHNlKSk7XG4gICAgfVxuXG4gICAgQ2hlY2tVcFVzZXIoRnJpZW5kc05hbWU6c3RyaW5nKVxuICAgIHtcbiAgICAgICAgbGV0IFRoaXNGcmllbmQ6QXJyYXk8Ym9vbGVhbj47XG4gICAgICAgICBUaGlzRnJpZW5kID0gbmV3IEFycmF5PGJvb2xlYW4+KCk7XG5cbiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGk8dGhpcy5BZGRVc2VyLmxlbmd0aDsgaSsrKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgaWYodGhpcy5BZGRVc2VyW2ldID09IEZyaWVuZHNOYW1lW2ldKVxuICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgIFRoaXNGcmllbmQucHVzaCh0cnVlKTtcbiAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICBUaGlzRnJpZW5kLnB1c2goZmFsc2UpO1xuICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IodmFyIGwgPSAwOyBsPFRoaXNGcmllbmQubGVuZ3RoOyBsKyspe1xuICAgICAgICAgICAgICAgIGlmKFRoaXNGcmllbmRbbF0gPT0gZmFsc2Upe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZihGcmllbmRzTmFtZSA9PSB0aGlzLlVzZXJuYW1lKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIEFkZFRoaXNVc2VyKClcbiAgICB7XG4gICAgICAgIHZhciBUaGlzQWRkVXNlciA9IHRoaXMuQWRkVXNlcjtcbiAgICAgICAgdmFyIG9uVXNlciA9IHRydWU7XG5cbiAgICAgICAgaWYodGhpcy5BZGRVc2VyID09IG51bGwpXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFsZXJ0KFwiTm90IGEgdmFsaWQgVXNlclwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgIHtcbiAgICAgICAgICAgIHZhciBvbkNoaWxkRXZlbnQgPSBmdW5jdGlvbihyZXN1bHQ6YW55KSBcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKSBcbiAgICAgICAgICAgICAgICB7ICAgXG4gICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuVXNlckNvbmZpcm1lZChzZWxmLkFkZFVzZXIsIHJlc3VsdC5rZXkpID09IHRydWUpXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuU2VuZFRvVXNlcihyZXN1bHQua2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uVXNlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgLy8gbGlzdGVuIHRvIGNoYW5nZXMgaW4gdGhlIC91c2VycyBwYXRoXG4gICAgICAgICAgICB0aGlzLnBhdGggPSBcIi9Vc2Vyc1wiO1xuICAgICAgICAgICAgZmlyZWJhc2UuYWRkQ2hpbGRFdmVudExpc3RlbmVyKG9uQ2hpbGRFdmVudCx0aGlzLnBhdGgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgVXNlckNvbmZpcm1lZChTZWFyY2hVc2VyOnN0cmluZywgRGF0YWJhc2VVc2VyOnN0cmluZyl7XG5cbiAgICAgICAgaWYoU2VhcmNoVXNlci50b0xvY2FsZUxvd2VyQ2FzZSgpID09IERhdGFiYXNlVXNlci50b0xvY2FsZUxvd2VyQ2FzZSgpJiZTZWFyY2hVc2VyLnRvTG9jYWxlTG93ZXJDYXNlKCkhPSB0aGlzLlVzZXJuYW1lLnRvTG93ZXJDYXNlKCkpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2VcbiAgICAgICAge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIFNlbmRUb1VzZXIoVGhpc0FkZFVzZXI6U3RyaW5nKVxuICAgIHtcbiAgICAgICAgZmlyZWJhc2Uuc2V0VmFsdWUoXCJVc2Vycy9cIitUaGlzQWRkVXNlcitcIi9GcmllbmRzL1JlcXVlc3QvXCIrdGhpcy5Vc2VybmFtZSAsIGZhbHNlKTtcbiAgICB9XG4gICAgR2V0RGFyZXMoKVxuICAgIHtcbiAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxuICAgICAgICB7XG4gICAgICAgICAgICBpZihyZXN1bHQudHlwZT09PVwiQ2hpbGRSZW1vdmVkXCIpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2VsZi5kZWxldGVEYXJlKHJlc3VsdC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdC50eXBlID09PSBcIkNoaWxkQWRkZWRcIikgXG4gICAgICAgICAgICB7ICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5ld0RhcmUocmVzdWx0LmtleSwgcmVzdWx0LnZhbHVlLkRhcmUsIHJlc3VsdC52YWx1ZS5Gcm9tKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiB0aGUgL3VzZXJzIHBhdGhcbiAgICAgICAgICAgIHRoaXMucGF0aCA9IFwiL0RhcmVzL1wiK3RoaXMuVXNlcm5hbWU7XG4gICAgICAgICAgICBmaXJlYmFzZS5hZGRDaGlsZEV2ZW50TGlzdGVuZXIob25DaGlsZEV2ZW50LHRoaXMucGF0aCk7XG4gICAgICAgICAgICB0aGlzLnBhdGggPSBcIlwiO1xuICAgIH1cblxuICAgIFNlbmQoKVxuICAgIHtcbiAgICAgICAgZmlyZWJhc2UucHVzaChcIkRhcmVzL1wiK3RoaXMuVXNlcm5hbWUseydGcm9tJzogdGhpcy5Vc2VybmFtZSwgJ0RhcmUnOnRoaXMuSW5wdXREYXJlfSk7XG4gICAgICAgIHRoaXMuc2V0KFwiVXNlcm5hbWVcIixcIlwiKTtcbiAgICAgICAgdGhpcy5zZXQoXCJJbnB1dERhcmVcIixcIlwiKTtcbiAgICB9XG5cbiAgICBTZXRBcHBsaWNhdGlvbihVc2VybmFtZTpzdHJpbmcpXG4gICAge1xuICAgICAgICBzZWxmID0gdGhpcztcbiAgICAgICAgdGhpcy5Vc2VybmFtZSA9IFVzZXJuYW1lO1xuICAgICAgICB0aGlzLnNldChcIkdVSVVzZXJcIix0aGlzLlVzZXJuYW1lKTtcbiAgICAgICAgdGhpcy5HZXRSZXF1ZXN0KCk7XG4gICAgICAgIHRoaXMuR2V0RnJpZW5kcygpO1xuICAgIH1cbiBcbiAgICBHZXRTY29yZSgpXG4gICAge1xuICAgICAgICB2YXIgb25DaGlsZEV2ZW50ID0gZnVuY3Rpb24ocmVzdWx0OmFueSkgXG4gICAgICAgIHtcbiAgICAgICAgICAgIHNlbGYuU2V0VUlTY29yZShyZXN1bHQudmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBwYXRoID0gXCIvVXNlcnMvXCIrdGhpcy5Vc2VybmFtZSArIFwiL1Njb3JlXCI7XG4gICAgICAgIGZpcmViYXNlLmFkZFZhbHVlRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQscGF0aCk7XG4gICAgfVxuXG4gICAgU2V0VUlTY29yZShBU2NvcmU6bnVtYmVyKVxuICAgIHtcbiAgICAgICAgdGhpcy5zZXQoXCJTY29yZVwiLCBBU2NvcmUpO1xuICAgIH1cblxuICAgIFNldFNjb3JlKClcbiAgICB7XG4gICAgICAgIGxldCBhZGRpbmcgPSAxMDtcbiAgICAgICAgdmFyIFJlc3VsdCA9IHRoaXMuU2NvcmU7XG4gICAgICAgIFJlc3VsdCA9IFJlc3VsdCArIGFkZGluZztcbiAgICAgICAgICBmaXJlYmFzZS51cGRhdGUoXG4gICAgICAgICAgICAnL1VzZXJzLycgKyB0aGlzLlVzZXJuYW1lLFxuICAgICAgICAgICAgeydTY29yZSc6IFJlc3VsdH1cbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgR2V0RnJpZW5kcygpXG4gICAge1xuICAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxuICAgICAgICAge1xuICAgICAgICAgICAgaWYocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRBZGRlZFwiKVxuICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZihzZWxmLlNldEZyaWVuZHMocmVzdWx0LmtleSkgPT0gdHJ1ZSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuQWRkRnJpZW5kc1RvTGlzdChyZXN1bHQua2V5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmKHJlc3VsdC50eXBlID09PSBcIkNoaWxkUmVtb3ZlZFwiKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHNlbGYuRGVsZXRlRnJpZW5kKHJlc3VsdC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBwYXRoID0gXCIvVXNlcnMvXCIrdGhpcy5Vc2VybmFtZSArIFwiL0ZyaWVuZHMvQWNjZXB0XCI7XG4gICAgICAgIGZpcmViYXNlLmFkZENoaWxkRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQscGF0aCk7XG4gICAgfVxuXG4gICAgR2V0UmVxdWVzdCgpXG4gICAge1xuICAgICAgICB2YXIgb25DaGlsZEV2ZW50ID0gZnVuY3Rpb24ocmVzdWx0OmFueSkgXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlmKHJlc3VsdC50eXBlID09PSBcIkNoaWxkQWRkZWRcIikgXG4gICAgICAgICAgICB7ICAgXG4gICAgICAgICAgICAgICAgc2VsZi5TZXRSZXF1ZXN0KHJlc3VsdC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgPT09IFwiQ2hpbGRSZW1vdmVkXCIpIFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHNlbGYuRGVsZXRlUmVxdWVzdChyZXN1bHQua2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiB0aGUgL3VzZXJzIHBhdGhcbiAgICAgICAgdGhpcy5wYXRoID0gXCIvVXNlcnMvXCIrdGhpcy5Vc2VybmFtZSArXCIvRnJpZW5kcy9SZXF1ZXN0XCI7XG4gICAgICAgIGZpcmViYXNlLmFkZENoaWxkRXZlbnRMaXN0ZW5lcihvbkNoaWxkRXZlbnQsdGhpcy5wYXRoKTtcbiAgICB9XG5cbiAgICBTZXRSZXF1ZXN0KGZyaWVuZDogc3RyaW5nKVxuICAgIHtcbiAgICAgICAgdGhpcy5GcmllbmRzQXNrLnB1c2gobmV3IEZyaWVuZCh0aGlzLlVzZXJuYW1lLGZyaWVuZCxmYWxzZSkpO1xuICAgIH1cblxuICAgIERlbGV0ZVJlcXVlc3QoZnJpZW5kOiBzdHJpbmcpXG4gICAge1xuICAgICAgICAgZm9yICh2YXIgaT0wO2k8dGhpcy5GcmllbmRzQXNrLmxlbmd0aDtpKyspIFxuICAgICAgICAge1xuICAgICAgICAgICAgaWYgKHRoaXMuRnJpZW5kc0Fzay5nZXRJdGVtKGkpLkZyaWVuZHNVc2VybmFtZS50b0xvd2VyQ2FzZSgpID09PSBmcmllbmQudG9Mb3dlckNhc2UoKSkgXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICB0aGlzLkZyaWVuZHNBc2suc3BsaWNlKGksMSk7XG4gICAgICAgICAgICB9ICAgXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBEZWxldGVGcmllbmQoZnJpZW5kOiBzdHJpbmcpXG4gICAge1xuICAgICAgICAgZm9yICh2YXIgaT0wO2k8dGhpcy5GcmllbmRzLmxlbmd0aDtpKyspIFxuICAgICAgICAge1xuICAgICAgICAgICAgaWYgKHRoaXMuRnJpZW5kcy5nZXRJdGVtKGkpLkZyaWVuZHNVc2VybmFtZS50b0xvd2VyQ2FzZSgpID09PSBmcmllbmQudG9Mb3dlckNhc2UoKSkgXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICB0aGlzLkZyaWVuZHMuc3BsaWNlKGksMSk7XG4gICAgICAgICAgICB9ICAgXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBTZXRGcmllbmRzKEFGcmllbmQ6IHN0cmluZylcbiAgICB7XG4gICAgICAgIHZhciBBZGRGcmllbmQgPSB0cnVlO1xuICAgICAgICBmb3IgKHZhciBpPTA7aTx0aGlzLkZyaWVuZHMubGVuZ3RoO2krKykgXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlmICh0aGlzLkZyaWVuZHMuZ2V0SXRlbShpKS5GcmllbmRzVXNlcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gQUZyaWVuZC50b0xvd2VyQ2FzZSgpKSBcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBBZGRGcmllbmQgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gICBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gQWRkRnJpZW5kO1xuICAgIH1cblxuICAgIEFkZEZyaWVuZHNUb0xpc3QoQUZyaWVuZDpzdHJpbmcpXG4gICAge1xuICAgICAgICB0aGlzLkZyaWVuZHMucHVzaChuZXcgRnJpZW5kKHRoaXMuVXNlcm5hbWUsIEFGcmllbmQsIHRydWUpKTtcbiAgICB9XG5cbiAgICBHb0JhY2soKVxuICAgIHtcbiAgICAgICAgXG4gICAgICAgIHdoaWxlKHRoaXMuRnJpZW5kcy5sZW5ndGggPiAwKVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLkZyaWVuZHMucG9wKCk7XG4gICAgICAgIH1cblxuICAgICAgICB3aGlsZSh0aGlzLkZyaWVuZHNBc2subGVuZ3RoID4gMClcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5GcmllbmRzQXNrLnBvcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgd2hpbGUodGhpcy5GcmllbmRzU2VhcmNoLmxlbmd0aCA+IDApXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuRnJpZW5kc1NlYXJjaC5wb3AoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuQWRkVXNlciA9IG51bGw7XG4gICAgICAgIHRoaXMuVXNlcm5hbWUgPSBudWxsO1xuICAgICAgICB0aGlzLnBhdGggPSBudWxsO1xuICAgICAgICBQYWdlLnRvcG1vc3QoKS5nb0JhY2soKTtcbiAgICB9XG4gIFxufSBcblxuZXhwb3J0IGRlZmF1bHQgTWFpbk1vZGVsOyJdfQ==