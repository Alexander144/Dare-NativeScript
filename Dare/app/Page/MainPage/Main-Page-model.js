"use strict";
var observable_1 = require("data/observable");
var observable_array_1 = require("data/observable-array");
var firebase = require("nativescript-plugin-firebase");
var Page = require("ui/frame");
var Dare_1 = require("../Class/Dare/Dare");
var self;
var MainModel = (function (_super) {
    __extends(MainModel, _super);
    function MainModel() {
        _super.call(this);
        this.Dares = new observable_array_1.ObservableArray();
        this.User = null;
        this.Score = 0;
        this.Image = "https://1.bp.blogspot.com/-YIfQT6q8ZM4/Vzyq5z1B8HI/AAAAAAAAAAc/UmWSSMLKtKgtH7CACElUp12zXkrPK5UoACLcB/s1600/image00.png";
        //Vet ikke om denne fungerer
        firebase.keepInSync("/Dares", // which path in your Firebase needs to be kept in sync?
        true // set to false to disable this feature again
        ).then(function () {
            console.log("firebase.keepInSync is ON for /Dares");
        }, function (error) {
            console.log("firebase.keepInSync error: " + error);
        });
    }
    MainModel.prototype.GetDares = function () {
        var path;
        var onChildEvent = function (result) {
            if (result.type === "ChildRemoved") {
                self.DeleteDare(result.key);
            }
            if (result.type === "ChildAdded") {
                if (self.CheckIfDareAdded(result.key) == true) {
                    self.NewDare(result.key, result.value.Dare, result.value.From);
                }
            }
        };
        // listen to changes in the /users path
        path = "/Dares/" + this.User;
        firebase.addChildEventListener(onChildEvent, path);
        path = "";
    };
    MainModel.prototype.GetScore = function () {
        var onChildEvent = function (result) {
            self.SetUIScore(result.value);
        };
        var path = "/Users/" + this.User + "/Score";
        firebase.addValueEventListener(onChildEvent, path);
    };
    MainModel.prototype.CheckIfDareAdded = function (id) {
        var AddDare = true;
        for (var i = 0; i < this.Dares.length; i++) {
            if (this.Dares.getItem(i).Id === id) {
                AddDare = false;
            }
        }
        return AddDare;
    };
    MainModel.prototype.DeleteDare = function (id) {
        this.SetScore();
        for (var i = 0; i < this.Dares.length; i++) {
            if (this.Dares.getItem(i).Id === id) {
                this.Dares.splice(i, 1);
                break;
            }
        }
    };
    MainModel.prototype.NewDare = function (id, nDare, From) {
        this.Dares.push(new Dare_1.default(id, nDare, From, this.User));
    };
    MainModel.prototype.SendDare = function () {
        firebase.uploadFile({
            // the full path of the file in your Firebase storage (folders will be created)
            remoteFullPath: 'uploads/images/telerik-logo-uploaded.png',
            // option 2: a full file path (ignored if 'localFile' is set)
            localFullPath: this.Image,
            // get notified of file upload progress
            onProgress: function (status) {
                console.log("Uploaded fraction: " + status.fractionCompleted);
                console.log("Percentage complete: " + status.percentageCompleted);
            }
        }).then(function (uploadedFile) {
            console.log("File uploaded: " + JSON.stringify(uploadedFile));
        }, function (error) {
            console.log("firebase.keepInSync error: " + error);
        });
        Page.topmost().navigate({
            moduleName: "Page/SendTo/SendTo",
            context: { Username: this.User, Dare: this.InputDare
            },
            transition: {
                name: "slideBottom",
                duration: 380,
                curve: "easeIn"
            },
            animated: true
        });
    };
    MainModel.prototype.SetApplication = function (Username) {
        self = this;
        this.User = Username;
        this.set("GUIUser", this.User);
        this.GetDares();
        this.GetScore();
    };
    MainModel.prototype.SetUIScore = function (AScore) {
        this.set("Score", AScore);
    };
    MainModel.prototype.SetScore = function () {
        var adding = 10;
        var Result = this.Score;
        Result = Result + adding;
        firebase.update('/Users/' + this.User, { 'Score': Result });
    };
    MainModel.prototype.GoToFriendsPage = function () {
        Page.topmost().navigate({
            moduleName: "Page/FriendsPage/Friends",
            context: { Username: this.User
            },
            transition: {
                name: "slideBottom",
                duration: 380,
                curve: "easeIn"
            },
            animated: true
        });
    };
    MainModel.prototype.Logout = function () {
        this.User = "";
        this.set("Username", "");
        this.set("InputDare", "");
        while (this.Dares.length > 0) {
            this.Dares.pop();
        }
        firebase.logout();
        Page.topmost().goBack();
    };
    return MainModel;
}(observable_1.Observable));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MainModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbi1QYWdlLW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFpbi1QYWdlLW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyQkFBMEIsaUJBQWlCLENBQUMsQ0FBQTtBQUM1QyxpQ0FBZ0MsdUJBQXVCLENBQUMsQ0FBQTtBQUN4RCxJQUFPLFFBQVEsV0FBVyw4QkFBOEIsQ0FBQyxDQUFDO0FBSTFELElBQU8sSUFBSSxXQUFXLFVBQVUsQ0FBQyxDQUFDO0FBQ2xDLHFCQUFpQixvQkFBb0IsQ0FBQyxDQUFBO0FBRXJDLElBQUksSUFBSSxDQUFDO0FBQ1Y7SUFBd0IsNkJBQVU7SUFROUI7UUFFSSxpQkFBTyxDQUFDO1FBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGtDQUFlLEVBQVEsQ0FBQztRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLEdBQUcsd0hBQXdILENBQUM7UUFFdEksNEJBQTRCO1FBQzFCLFFBQVEsQ0FBQyxVQUFVLENBQ2hCLFFBQVEsRUFBRSx3REFBd0Q7UUFDbEUsSUFBSSxDQUFNLDZDQUE2QztTQUN2RCxDQUFDLElBQUksQ0FDTjtZQUNJLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQztRQUN4RCxDQUFDLEVBQ0QsVUFBQyxLQUFLO1lBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFRCw0QkFBUSxHQUFSO1FBRUksSUFBSSxJQUFZLENBQUM7UUFDakIsSUFBSSxZQUFZLEdBQUcsVUFBUyxNQUFVO1lBRWxDLEVBQUUsQ0FBQSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUcsY0FBYyxDQUFDLENBQ2hDLENBQUM7Z0JBQ0csSUFBSSxDQUFDLFVBQVUsQ0FBQyxN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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnR7IE9ic2VydmFibGUgfSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlQXJyYXkgfSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlLWFycmF5XCI7XG5pbXBvcnQgZmlyZWJhc2UgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXBsdWdpbi1maXJlYmFzZVwiKTtcbmltcG9ydCBsaXN0UGlja2VyTW9kdWxlID0gcmVxdWlyZShcInVpL2xpc3QtcGlja2VyXCIpO1xuaW1wb3J0IHtFdmVudERhdGF9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcblxuaW1wb3J0IFBhZ2UgPSByZXF1aXJlKFwidWkvZnJhbWVcIik7XG5pbXBvcnQgRGFyZSBmcm9tIFwiLi4vQ2xhc3MvRGFyZS9EYXJlXCI7XG5cbiB2YXIgc2VsZjtcbmNsYXNzIE1haW5Nb2RlbCBleHRlbmRzIE9ic2VydmFibGV7XG4gICAgRGFyZXM6IE9ic2VydmFibGVBcnJheTxEYXJlPjtcbiAgICBVc2VyOiBzdHJpbmc7XG4gICAgVXNlcm5hbWU6IHN0cmluZztcbiAgICBJbnB1dERhcmU6IHN0cmluZztcbiAgICBTY29yZTogbnVtYmVyO1xuICAgIEltYWdlOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcigpXG4gICAge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLkRhcmVzID0gbmV3IE9ic2VydmFibGVBcnJheTxEYXJlPigpO1xuICAgICAgICB0aGlzLlVzZXIgPSBudWxsO1xuICAgICAgICB0aGlzLlNjb3JlID0gMDtcbiAgICAgICAgdGhpcy5JbWFnZSA9IFwiaHR0cHM6Ly8xLmJwLmJsb2dzcG90LmNvbS8tWUlmUVQ2cThaTTQvVnp5cTV6MUI4SEkvQUFBQUFBQUFBQWMvVW1XU1NNTEt0S2d0SDdDQUNFbFVwMTJ6WGtyUEs1VW9BQ0xjQi9zMTYwMC9pbWFnZTAwLnBuZ1wiO1xuICAgICAgIFxuICAgICAgICAvL1ZldCBpa2tlIG9tIGRlbm5lIGZ1bmdlcmVyXG4gICAgICAgICAgZmlyZWJhc2Uua2VlcEluU3luYyhcbiAgICAgICAgICAgICBcIi9EYXJlc1wiLCAvLyB3aGljaCBwYXRoIGluIHlvdXIgRmlyZWJhc2UgbmVlZHMgdG8gYmUga2VwdCBpbiBzeW5jP1xuICAgICAgICAgICAgIHRydWUgICAgICAvLyBzZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSB0aGlzIGZlYXR1cmUgYWdhaW5cbiAgICAgICAgICAgICkudGhlbihcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImZpcmViYXNlLmtlZXBJblN5bmMgaXMgT04gZm9yIC9EYXJlc1wiKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZmlyZWJhc2Uua2VlcEluU3luYyBlcnJvcjogXCIgKyBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgR2V0RGFyZXMoKVxuICAgIHtcbiAgICAgICAgbGV0IHBhdGg6IHN0cmluZztcbiAgICAgICAgdmFyIG9uQ2hpbGRFdmVudCA9IGZ1bmN0aW9uKHJlc3VsdDphbnkpIFxuICAgICAgICB7XG4gICAgICAgICAgICBpZihyZXN1bHQudHlwZT09PVwiQ2hpbGRSZW1vdmVkXCIpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2VsZi5EZWxldGVEYXJlKHJlc3VsdC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdC50eXBlID09PSBcIkNoaWxkQWRkZWRcIikgXG4gICAgICAgICAgICB7XG5cbiAgICAgICAgICAgICAgICBpZihzZWxmLkNoZWNrSWZEYXJlQWRkZWQocmVzdWx0LmtleSkgPT0gdHJ1ZSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc2VsZi5OZXdEYXJlKHJlc3VsdC5rZXksIHJlc3VsdC52YWx1ZS5EYXJlLCByZXN1bHQudmFsdWUuRnJvbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgICAgICAvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiB0aGUgL3VzZXJzIHBhdGhcbiAgICAgICAgICAgIHBhdGggPSBcIi9EYXJlcy9cIit0aGlzLlVzZXI7XG4gICAgICAgICAgICBmaXJlYmFzZS5hZGRDaGlsZEV2ZW50TGlzdGVuZXIob25DaGlsZEV2ZW50LHBhdGgpO1xuICAgICAgICAgICAgcGF0aCA9IFwiXCI7XG4gICAgfVxuICAgIEdldFNjb3JlKClcbiAgICB7ICAgIFxuICAgICAgICB2YXIgb25DaGlsZEV2ZW50ID0gZnVuY3Rpb24ocmVzdWx0OmFueSkgXG4gICAgICAgIHtcbiAgICAgICAgICAgIHNlbGYuU2V0VUlTY29yZShyZXN1bHQudmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBwYXRoID0gXCIvVXNlcnMvXCIrdGhpcy5Vc2VyICsgXCIvU2NvcmVcIjtcbiAgICAgICAgZmlyZWJhc2UuYWRkVmFsdWVFdmVudExpc3RlbmVyKG9uQ2hpbGRFdmVudCxwYXRoKTtcbiAgICB9XG5cbiAgICBDaGVja0lmRGFyZUFkZGVkKGlkOnN0cmluZylcbiAgICB7XG4gICAgICAgIHZhciBBZGREYXJlID0gdHJ1ZTtcbiAgICAgICAgZm9yICh2YXIgaT0wO2k8dGhpcy5EYXJlcy5sZW5ndGg7aSsrKSBcbiAgICAgICAge1xuICAgICAgICAgICAgaWYgKHRoaXMuRGFyZXMuZ2V0SXRlbShpKS5JZCA9PT0gaWQpIFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIEFkZERhcmUgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gICBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gQWRkRGFyZTtcbiAgICB9XG4gICAgXG4gICAgRGVsZXRlRGFyZShpZDpzdHJpbmcpXG4gICAge1xuICAgICAgICB0aGlzLlNldFNjb3JlKCk7XG4gICAgICAgIGZvciAodmFyIGk9MDtpPHRoaXMuRGFyZXMubGVuZ3RoO2krKykgXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlmICh0aGlzLkRhcmVzLmdldEl0ZW0oaSkuSWQgPT09IGlkKSBcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0aGlzLkRhcmVzLnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgTmV3RGFyZShpZDpzdHJpbmcsIG5EYXJlOnN0cmluZywgRnJvbTpzdHJpbmcpXG4gICAge1xuICAgICAgICB0aGlzLkRhcmVzLnB1c2gobmV3IERhcmUoaWQsbkRhcmUsRnJvbSx0aGlzLlVzZXIpKTtcbiAgICB9XG5cbiAgICBTZW5kRGFyZSgpXG4gICAgeyBcbiAgICAgICAgZmlyZWJhc2UudXBsb2FkRmlsZSh7XG4gICAgICAgIC8vIHRoZSBmdWxsIHBhdGggb2YgdGhlIGZpbGUgaW4geW91ciBGaXJlYmFzZSBzdG9yYWdlIChmb2xkZXJzIHdpbGwgYmUgY3JlYXRlZClcbiAgICAgICAgcmVtb3RlRnVsbFBhdGg6ICd1cGxvYWRzL2ltYWdlcy90ZWxlcmlrLWxvZ28tdXBsb2FkZWQucG5nJyxcbiAgICAgICAgLy8gb3B0aW9uIDI6IGEgZnVsbCBmaWxlIHBhdGggKGlnbm9yZWQgaWYgJ2xvY2FsRmlsZScgaXMgc2V0KVxuICAgICAgICBsb2NhbEZ1bGxQYXRoOiB0aGlzLkltYWdlLFxuICAgICAgICAvLyBnZXQgbm90aWZpZWQgb2YgZmlsZSB1cGxvYWQgcHJvZ3Jlc3NcbiAgICAgICAgb25Qcm9ncmVzczogZnVuY3Rpb24oc3RhdHVzKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXCJVcGxvYWRlZCBmcmFjdGlvbjogXCIgKyBzdGF0dXMuZnJhY3Rpb25Db21wbGV0ZWQpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiUGVyY2VudGFnZSBjb21wbGV0ZTogXCIgKyBzdGF0dXMucGVyY2VudGFnZUNvbXBsZXRlZCk7XG4gICAgICAgIH1cbiAgICAgIH0pLnRoZW4oXG4gICAgICAgICAgICAodXBsb2FkZWRGaWxlKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRmlsZSB1cGxvYWRlZDogXCIgKyBKU09OLnN0cmluZ2lmeSh1cGxvYWRlZEZpbGUpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZmlyZWJhc2Uua2VlcEluU3luYyBlcnJvcjogXCIgKyBlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIFBhZ2UudG9wbW9zdCgpLm5hdmlnYXRlKFxuICAgICAgICB7XG4gICAgICAgICAgICBtb2R1bGVOYW1lOiBcIlBhZ2UvU2VuZFRvL1NlbmRUb1wiLFxuICAgICAgICAgICAgY29udGV4dDp7VXNlcm5hbWU6IHRoaXMuVXNlciwgRGFyZTp0aGlzLklucHV0RGFyZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zaXRpb246IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBcInNsaWRlQm90dG9tXCIsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDM4MCxcbiAgICAgICAgICAgICAgICBjdXJ2ZTogXCJlYXNlSW5cIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFuaW1hdGVkOiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBTZXRBcHBsaWNhdGlvbihVc2VybmFtZTpzdHJpbmcpXG4gICAge1xuICAgICAgICBzZWxmID0gdGhpcztcbiAgICAgICAgdGhpcy5Vc2VyID0gVXNlcm5hbWU7XG4gICAgICAgIHRoaXMuc2V0KFwiR1VJVXNlclwiLHRoaXMuVXNlcik7XG4gICAgICAgIHRoaXMuR2V0RGFyZXMoKTtcbiAgICAgICAgdGhpcy5HZXRTY29yZSgpO1xuICAgIH1cblxuICBcbiAgICBTZXRVSVNjb3JlKEFTY29yZTpudW1iZXIpXG4gICAge1xuICAgICAgICB0aGlzLnNldChcIlNjb3JlXCIsIEFTY29yZSk7XG4gICAgfVxuXG4gICAgU2V0U2NvcmUoKVxuICAgIHtcbiAgICAgICAgbGV0IGFkZGluZyA9IDEwO1xuICAgICAgICB2YXIgUmVzdWx0ID0gdGhpcy5TY29yZTtcbiAgICAgICBcbiAgICAgICAgUmVzdWx0ID0gUmVzdWx0ICsgYWRkaW5nO1xuICAgICAgICBmaXJlYmFzZS51cGRhdGUoXG4gICAgICAgICAgICAnL1VzZXJzLycgKyB0aGlzLlVzZXIsXG4gICAgICAgICAgICB7J1Njb3JlJzogUmVzdWx0fVxuICAgICAgICApO1xuICAgIH1cblxuICAgIEdvVG9GcmllbmRzUGFnZSgpXG4gICAge1xuICAgICAgICBQYWdlLnRvcG1vc3QoKS5uYXZpZ2F0ZShcbiAgICAgICAge1xuICAgICAgICAgICAgbW9kdWxlTmFtZTogXCJQYWdlL0ZyaWVuZHNQYWdlL0ZyaWVuZHNcIixcbiAgICAgICAgICAgICBjb250ZXh0OntVc2VybmFtZTogdGhpcy5Vc2VyXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zaXRpb246IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBcInNsaWRlQm90dG9tXCIsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDM4MCxcbiAgICAgICAgICAgICAgICBjdXJ2ZTogXCJlYXNlSW5cIlxuICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhbmltYXRlZDogdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgTG9nb3V0KClcbiAgICB7XG4gICAgICAgIHRoaXMuVXNlciA9IFwiXCI7XG4gICAgICAgIHRoaXMuc2V0KFwiVXNlcm5hbWVcIixcIlwiKTtcbiAgICAgICAgdGhpcy5zZXQoXCJJbnB1dERhcmVcIixcIlwiKTtcbiAgICAgICAgd2hpbGUodGhpcy5EYXJlcy5sZW5ndGggPiAwKVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLkRhcmVzLnBvcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZmlyZWJhc2UubG9nb3V0KCk7XG4gICAgICAgIFxuICAgICAgICBQYWdlLnRvcG1vc3QoKS5nb0JhY2soKTtcbiAgICB9XG4gIFxufSBcblxuZXhwb3J0IGRlZmF1bHQgTWFpbk1vZGVsOyJdfQ==